---
title: "Mapping Assignment"
author: "Michael Kohler"
date: "4/7/2109"
output: html_document
---

# Loading and preparing the data

```{r setup}
library(tidyverse)
library(leaflet)
library(USAboundaries)
library(sf)


# Load the data
pop_1850 <- read_csv("mapping_files/pop_1850.csv")
total_1860 <- read_csv("mapping_files/total_1860.csv")
race_1860 <- read_csv("mapping_files/race_1860.csv")
race_1870 <- read_csv("mapping_files/race_1870.csv")
total_1870 <- read.csv("mapping_files/total_1870.csv")

VA_pop_1850 <- pop_1850 %>% 
  rowwise() %>%
  mutate(total_black = sum( free_black, total_slave, na.rm = TRUE)) %>% 
    select(state = STATE,
           county = COUNTY,
           year = YEAR,
           full_name,
           total_pops = total_population,
           total_black,
           free_black,
           total_slave,
           total_white) %>% 
  filter(state == "Virginia")

VA_pop_1860 <- race_1860 %>% 
  left_join(total_1860) %>% 
  rowwise() %>%
  mutate(total_black = sum( free_black, total_slave, na.rm = TRUE)) %>% 
  select(state = STATE,
           county = COUNTY,
           year = YEAR,
           full_name,
           total_pops = total_population,
           total_black,
           free_black,
           total_slave,
           total_white) %>% 
  filter(state == "Virginia")

VA_pop_1870 <- race_1870 %>% 
  left_join(total_1870) %>% 
  rowwise() %>%
  select(state = STATE,
           county = COUNTY,
           year = YEAR,
           full_name,
           total_pops = total_population,
           total_black = free_black,
           total_white) %>% 
  filter(state == "Virginia")

VA_pop_50_60 <- right_join(VA_pop_1850, VA_pop_1860, by = "GISJOIN", "county")


         

# Load the shapefiles and de-project to lat/long representations
counties_va_1860 <- us_counties("1860-06-01", states = "Virginia")

# Get the state centers
  centroids_va_1860 <- counties_va_1860 %>% 
    st_centroid()
```

Some helper functions.

```{r}
# Plot just the geometries
plot(st_geometry(counties_va_1860))
# Plot a variable
plot(counties_va_1860["SHAPE_AREA"])
```


I did a lot of the codebook stuff manually before I loaded by .csv files, partly because I wanted to avoid changing labels (though I think that was unnecessary work.  Either way, let's figure out the difference in slave populations between these counties as a percentage. 
```{r}
VA_pop <- VA_pop_50_60 %>%
  select(GISJOIN, 
         county = county.y,
         total_1850 = total_pops.x,
         black_1850 = total_black.x,
         slave_1850 = total_slave.x,
         white_1850 = total_white.x,
         total_1860 = total_pops.y,
         black_1860 = total_black.y,
         slave_1860 = total_slave.y,
         white_1860 = total_white.y) %>%
  mutate(slave_diff = sum(slave_1860 - slave_1850, na.rm = FALSE)) %>% 
  mutate(diff_percent = round(slave_diff / slave_1850, 3)) %>% 
  arrange(desc(diff_percent))

```

# Exploratory analysis

Ok. I beat my head into the wall for a while on this one. For some reason I just couldn't get top_n to work, no matter where I put it or how I changed it. I must have run 30 different versions. I'm really not sure what I'm doing wrong. Even online guides couldn't help me. I was going to post in slack about it, but, frankly, feel like I've wasted too much time on it and need to move on. The data is there and it works. New counties (which, therefore, have an NA) got tossed and the data looks manipulatable.


```{r}
VA_pop %>% 
  top_n(10, diff_percent) %>% 
  select(county, diff_percent) %>%  
  mutate(diff_percent = diff_percent * 100) %>% 
  knitr::kable(format.args = list(big.mark = ","))

#WHY WILL THIS NOT WORK?????
```

Unsurprisingly, most counties don't experience wild shifts in the slave population, and I'm betting that the ones who did were tiny and didn't have many to begin with (like remote areas of what's now West Virginia.)

```{r}
ggplot(VA_pop, aes(x = diff_percent)) +
  geom_histogram(binwidth = 0.05)
```

Hmm. Another one where the important stuff works, but the command to put results in a specific order does nothing. Again, I tried moving things around but nothing seemed to change the results. Always it was in reverse order by county name. Which is just weird. The mapping_demo.rmd code was essentially identicall with different variables. Ug.

```{r}
VA_pop %>% 
  arrange(desc(slave_diff)) %>% 
  mutate(county = fct_inorder(county)) %>% 
  filter(slave_diff < -50) %>% 
  ggplot(aes(x = county, y = slave_diff)) +
  geom_col() +
  coord_flip()
```

## Mapping

## Joining data

Our state data is in two variables. `centroids_1890` has the latitude and longitude of the state centers, while `states_1890` has the polygons for the states. Our census data is in the `german` data frame, or more broadly in the `nativity_1890` data frame. We need to bring these two together with a `left_join()`. Luckily, NHGIS provides the `GISJOIN` column. Note: geometries on the left!

## Points

We will start with centroids since they are easier to map.

```{r}
VA_points <- centroids_va_1860 %>% 
  left_join(VA_pop, by = "GIS")
```

We can make a leaflet map with similar synatx to ggplot2.

```{r}
leaflet(german_points) %>% 
  addTiles() %>% 
  addMarkers()
```

Markers are not very interesting. We want to set the radius of the circle to the square root of the population.

```{r}
pop_scale <- function(x, max_radius = 20) {
  x %>% 
    sqrt() %>% 
    scales::rescale_max(to = c(0, max_radius))
}
pop_scale(german_points$german) %>% head()
```


```{r}
leaflet(german_points) %>% 
  addTiles() %>% 
  addCircleMarkers(radius = ~pop_scale(german),
                   label = ~state,
                   popup = ~paste0(state, ": ", german),
                   color = "red")
```

## Polygons

First we need to join the polygons to the German data.

```{r}
german_shapes <- states_1890 %>% 
  left_join(german, by = "GISJOIN")
```

Now we can map the polygons.

```{r}
leaflet(german_shapes) %>% 
  addTiles() %>% 
  addPolygons(label = ~state)
```

When we mapped the German population as points, we needed to scale the levels to pixels. Now we need to go from populations or percentages to colors. Leaflet provides a helper function.

```{r}
german_percent_colors <- colorNumeric("PuRd", domain = german$german_percent)
german_percent_colors(german$german_percent) %>% head()
```

Now we can fill in the map.

```{r}
leaflet(german_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~german_percent_colors(german_percent),
              fillOpacity = 1,
              color = "black", weight = 1,
              label = ~state,
              popup = ~paste0(state, ": ", 100 * german_percent, "%")) %>% 
  addLegend("bottomright", pal = german_percent_colors, values = ~german_percent,
    title = "German born",
    labFormat = labelFormat(suffix = "%",
                            transform = function(x) {x * 100}),
    opacity = 1
  )
```


